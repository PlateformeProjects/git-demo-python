name: CI Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    types: [opened, reopened]

jobs:
  test:
    name: CI Tests # pour que github le voit comme check PR
    runs-on: ubuntu-latest
    outputs:
      test-result: ${{ steps.set-test-result.outputs.result }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        id: run-tests
        run: |
          pytest -vv
        continue-on-error: true

      - name: Set test result
        id: set-test-result
        run: |
          if [ "${{ steps.run-tests.outcome }}" == "success" ]; then
            echo "result=SUCCESS" >> $GITHUB_OUTPUT
          else
            echo "result=FAILURE" >> $GITHUB_OUTPUT
          fi

  create_trello_card:
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened')
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Create Trello Card
        run: |
          # PrÃ©parer la description avec toutes les infos
          DESCRIPTION="## ğŸ“‹ Pull Request Details%0A%0A"
          DESCRIPTION="${DESCRIPTION}**ğŸ‘¤ Auteur**: ${{ github.actor }}%0A"
          DESCRIPTION="${DESCRIPTION}**ğŸ”€ Branche source**: \`${{ github.head_ref }}\`%0A"
          DESCRIPTION="${DESCRIPTION}**ğŸ¯ Branche cible**: \`${{ github.base_ref }}\`%0A"
          DESCRIPTION="${DESCRIPTION}**ğŸ“Š Statut des tests**: ${{ needs.test.outputs.test-result == 'SUCCESS' && 'âœ… RÃ‰USSI' || 'âŒ Ã‰CHOUÃ‰' }}%0A"
          DESCRIPTION="${DESCRIPTION}**ğŸ“ Titre**: ${{ github.event.pull_request.title }}%0A"
          DESCRIPTION="${DESCRIPTION}**ğŸ“… Date**: $(date +'%Y-%m-%d %H:%M:%S')%0A"
          DESCRIPTION="${DESCRIPTION}**ğŸ”¢ Nombre de commits**: ${{ github.event.pull_request.commits }}%0A"
          DESCRIPTION="${DESCRIPTION}**ğŸ“‚ Fichiers modifiÃ©s**: ${{ github.event.pull_request.changed_files }}%0A"
          DESCRIPTION="${DESCRIPTION}**â• Lignes ajoutÃ©es**: ${{ github.event.pull_request.additions }}%0A"
          DESCRIPTION="${DESCRIPTION}**â– Lignes supprimÃ©es**: ${{ github.event.pull_request.deletions }}%0A%0A"
          DESCRIPTION="${DESCRIPTION}## ğŸ’¬ Description de la PR%0A%0A"
          DESCRIPTION="${DESCRIPTION}${{ github.event.pull_request.body || 'Aucune description fournie' }}%0A%0A"
          DESCRIPTION="${DESCRIPTION}----%0A%0A"
          DESCRIPTION="${DESCRIPTION}ğŸ”— [Voir la Pull Request](${{ github.event.pull_request.html_url }})%0A"
          DESCRIPTION="${DESCRIPTION}ğŸ”— [Voir les commits](${{ github.event.pull_request.html_url }}/commits)%0A"
          DESCRIPTION="${DESCRIPTION}ğŸ”— [Voir les fichiers modifiÃ©s](${{ github.event.pull_request.html_url }}/files)"
          
          # CrÃ©er la carte avec un titre plus descriptif
          curl -X POST "https://api.trello.com/1/cards" \
            -d "key=${{ secrets.TRELLO_API_KEY }}" \
            -d "token=${{ secrets.TRELLO_TOKEN }}" \
            -d "idList=${{ secrets.TRELLO_LIST_ID }}" \
            -d "name=ğŸ”„ PR #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}" \
            -d "desc=${DESCRIPTION}" \
            -d "pos=top"

  notify_pull_request:
    if: github.event_name == 'pull_request'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Notify Google Chat - PR
        uses: SimonScholz/google-chat-action@main
        with:
          webhookUrl: ${{ secrets.GOOGLE_CHAT_URL }}
          title: "Pull Request demandÃ©e sur ${{ github.head_ref }} par ${{ github.actor }}"
          subtitle: "RÃ©sultat des tests: ${{ needs.test.outputs.test-result }}"

  notify_merge_main:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Notify Google Chat - Merge
        uses: SimonScholz/google-chat-action@main
        with:
          webhookUrl: ${{ secrets.GOOGLE_CHAT_URL }}
          title: "Merge sur main par ${{ github.actor }}"
          subtitle: "RÃ©sultat des tests: ${{ needs.test.outputs.test-result }}"